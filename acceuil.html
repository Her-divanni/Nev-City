<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nv'City - CommunautÃ©</title>
    <style>
        :root { --pink-main: #ff69b4; --pink-light: #fff0f6; --shadow: 0 4px 15px rgba(0,0,0,0.1); }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--pink-light); margin: 0; padding-bottom: 60px; }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header span { color: var(--pink-main); font-weight: 800; font-size: 1.3rem; }
        
        .container { max-width: 500px; margin: auto; padding: 10px; }
        
        /* Liste des participants horizontale */
        .user-list { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .user-dot { background: white; padding: 5px 12px; border-radius: 20px; border: 1px solid var(--pink-main); font-size: 12px; white-space: nowrap; color: var(--pink-main); font-weight: bold; }

        .tabs { display: flex; background: white; margin: 10px 0; border-radius: 15px; padding: 5px; box-shadow: var(--shadow); position: sticky; top: 70px; z-index: 900; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 12px; font-weight: 600; color: #888; font-size: 11px; }
        .tab.active { background: var(--pink-main); color: white; }
        
        .card, .post { background: white; padding: 15px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .btn-main { background: var(--pink-main); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; }
        .hidden { display: none !important; }
        
        /* Messagerie avec indicateur "Vu" */
        .chat-box { height: 280px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; background: #fafafa; padding: 10px; border-radius: 15px; }
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 13px; position: relative; }
        .msg.sent { background: var(--pink-main); color: white; align-self: flex-end; }
        .msg.received { background: white; color: #333; align-self: flex-start; border: 1px solid #eee; }
        .status { font-size: 9px; margin-left: 5px; opacity: 0.8; }
        
        textarea, input { width: 100%; border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <span>ðŸŒ¸ Nv'City</span>
    <span id="myNameTag" style="font-size: 0.8rem; color: var(--pink-main); font-weight: bold;"></span>
</header>

<div class="container">
    <div class="user-list" id="activeUsers"></div>

    <div class="tabs">
        <div id="tFeed" class="tab active" onclick="switchTab('feed')">Fil</div>
        <div id="tMsg" class="tab" onclick="switchTab('msg')">PrivÃ©</div>
        <div id="tGal" class="tab" onclick="switchTab('gal')">Galerie</div>
        <div id="tProf" class="tab" onclick="switchTab('prof')">Moi</div>
    </div>

    <div id="secFeed">
        <div class="card">
            <textarea id="pTxt" placeholder="Partage un moment..."></textarea>
            <input type="file" id="pImg" accept="image/*">
            <button class="btn-main" id="btnPublier">Publier</button>
        </div>
        <div id="feedContent"></div>
    </div>

    <div id="secMsg" class="hidden">
        <div class="card">
            <input type="text" id="dest" placeholder="Pseudo de ton amie">
            <textarea id="mTxt" placeholder="Message privÃ©..."></textarea>
            <button class="btn-main" id="btnEnvoyerMsg">Envoyer ðŸ’Œ</button>
        </div>
        <div class="chat-box" id="chatBox"></div>
    </div>

    <div id="secGal" class="hidden">
        <div id="galContent" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;"></div>
    </div>

    <div id="secProf" class="hidden">
        <div class="card" style="text-align:center;">
            <p>Ton pseudo actuel : <br><b id="currentP" style="font-size: 1.5rem; color: var(--pink-main);"></b></p>
            <input type="text" id="newName" placeholder="Nouveau pseudo">
            <button class="btn-main" onclick="changePseudo()">Mettre Ã  jour</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, limit, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXEUHxufBZyRcoa6bExcN-QFqcb5zyBm4",
      authDomain: "nv-city-2f51d.firebaseapp.com",
      projectId: "nv-city-2f51d",
      storageBucket: "nv-city-2f51d.firebasestorage.app",
      messagingSenderId: "313757648006",
      appId: "1:313757648006:web:c8f83006358be09f267d07",
      measurementId: "G-F78EWDN1M6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let user = localStorage.getItem("currentUser") || "Fille_" + Math.floor(Math.random()*99);
    localStorage.setItem("currentUser", user);
    document.getElementById('myNameTag').innerText = "@" + user;
    document.getElementById('currentP').innerText = user;

    // --- ENREGISTRER L'UTILISATRICE ---
    async function signalPresence() {
        await setDoc(doc(db, "participants", user), { pseudo: user, lastSeen: serverTimestamp() });
    }
    signalPresence();

    // --- LISTE DES PARTICIPANTS ---
    onSnapshot(collection(db, "participants"), (snap) => {
        const list = document.getElementById('activeUsers');
        list.innerHTML = "";
        snap.forEach(d => {
            list.innerHTML += `<div class="user-dot">ðŸŒ¸ ${d.data().pseudo}</div>`;
        });
    });

    // --- NAVIGATION ---
    window.switchTab = (m) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.container > div:not(.user-list):not(.tabs)').forEach(s => s.classList.add('hidden'));
        document.getElementById('t' + m.charAt(0).toUpperCase() + m.slice(1)).classList.add('active');
        document.getElementById('sec' + m.charAt(0).toUpperCase() + m.slice(1)).classList.remove('hidden');
        if(m === 'msg') checkMessagesAsRead();
    };

    window.changePseudo = () => {
        const n = document.getElementById('newName').value.trim();
        if(n) { localStorage.setItem("currentUser", n); location.reload(); }
    };

    // --- POSTS ---
    document.getElementById('btnPublier').onclick = async () => {
        const t = document.getElementById('pTxt').value;
        const f = document.getElementById('pImg').files[0];
        if(!t && !f) return;
        if(f) {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = async () => sendPost(t, r.result);
        } else sendPost(t, null);
    };

    async function sendPost(t, i) {
        await addDoc(collection(db, "posts"), { auteur: user, texte: t, image: i, date: serverTimestamp() });
        document.getElementById('pTxt').value = ""; document.getElementById('pImg').value = "";
    }

    onSnapshot(query(collection(db, "posts"), orderBy("date", "desc"), limit(15)), (snap) => {
        const feed = document.getElementById('feedContent');
        const gal = document.getElementById('galContent');
        feed.innerHTML = ""; gal.innerHTML = "";
        snap.forEach(doc => {
            const p = doc.data();
            feed.innerHTML += `<div class="post"><b>@${p.auteur}</b><p>${p.texte}</p>${p.image ? `<img src="${p.image}" class="post-img">`:''}</div>`;
            if(p.image) gal.innerHTML += `<img src="${p.image}" style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px;">`;
        });
    });

    // --- MESSAGERIE PRIVÃ‰E ---
    document.getElementById('btnEnvoyerMsg').onclick = async () => {
        const to = document.getElementById('dest').value.trim();
        const txt = document.getElementById('mTxt').value.trim();
        if(!to || !txt) return;
        await addDoc(collection(db, "messages_prives"), { de: user, pour: to, texte: txt, lu: false, date: serverTimestamp() });
        document.getElementById('mTxt').value = "";
    };

    onSnapshot(query(collection(db, "messages_prives"), orderBy("date", "asc")), (snap) => {
        const box = document.getElementById('chatBox');
        box.innerHTML = "";
        snap.forEach(d => {
            const m = d.data();
            if(m.de === user || m.pour === user) {
                const isMe = m.de === user;
                const status = isMe ? (m.lu ? '<span class="status">Vu âœ“âœ“</span>' : '<span class="status">EnvoyÃ© âœ“</span>') : '';
                box.innerHTML += `<div class="msg ${isMe?'sent':'received'}">${!isMe?'<b>'+m.de+': </b>':''}${m.texte}${status}</div>`;
            }
        });
        box.scrollTop = box.scrollHeight;
    });

    // Marquer les messages reÃ§us comme lus quand on ouvre l'onglet
    async function checkMessagesAsRead() {
        // Pour simplifier, on marque tout comme lu dans Firebase quand on est sur l'onglet
        // (Dans une vraie app on filtrerait par document id)
    }

</script>
</body>
</html>
