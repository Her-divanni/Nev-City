<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tena Iz - Cloud Edition</title>
    <style>
        :root { --pink-main: #ff69b4; --pink-light: #fff0f6; --shadow: 0 4px 15px rgba(0,0,0,0.1); }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--pink-light); margin: 0; padding-bottom: 50px; }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header span { color: var(--pink-main); font-weight: 800; font-size: 1.3rem; }
        .container { max-width: 500px; margin: auto; padding: 10px; }
        .tabs { display: flex; background: white; margin: 15px 0; border-radius: 15px; padding: 5px; box-shadow: var(--shadow); position: sticky; top: 70px; z-index: 900; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 12px; font-weight: 600; color: #888; font-size: 13px; transition: 0.3s; }
        .tab.active { background: var(--pink-main); color: white; }
        .card, .post { background: white; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 20px; position: relative; }
        .post-header { display: flex; align-items: center; margin-bottom: 12px; }
        .mini-avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 1px solid #eee; }
        .post-img { width: 100%; border-radius: 15px; margin-top: 12px; }
        .btn-main { background: var(--pink-main); color: white; border: none; padding: 14px; border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; }
        .hidden { display: none !important; }
        textarea, input { width: 100%; border: 1px solid #eee; background: #fbfbfb; border-radius: 12px; padding: 12px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <span>ðŸŒ¸ Tena Iz</span>
    <button onclick="localStorage.removeItem('currentUser'); location.reload();" style="border:none; background:none; color:#999; font-weight:600;">Quitter</button>
</header>

<div class="container">
    <div class="tabs">
        <div id="tFeed" class="tab active" onclick="switchTab('feed')">Fil</div>
        <div id="tGal" class="tab" onclick="switchTab('gal')">Galerie</div>
        <div id="tProf" class="tab" onclick="switchTab('prof')">Profil</div>
    </div>

    <div id="secFeed">
        <div class="card">
            <textarea id="pTxt" placeholder="Quoi de neuf ?"></textarea>
            <input type="file" id="pImg" accept="image/*">
            <button class="btn-main" id="btnPublier">Partager sur le Cloud</button>
        </div>
        <div id="feedContent">Chargement...</div>
    </div>

    <div id="secGal" class="hidden">
        <div id="galContent" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
    </div>

    <div id="secProf" class="hidden">
        <div class="card" style="text-align:center;">
            <img id="myAvatar" src="" class="mini-avatar" style="width:100px; height:100px;">
            <h2 id="myName">Pseudo</h2>
            <input type="text" id="newName" placeholder="Changer de pseudo">
            <button class="btn-main" onclick="updatePseudo()">Sauvegarder</button>
        </div>
    </div>
</div>

<script type="module">
    // --- INITIALISATION FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXEUHxufBZyRcoa6bExcN-QFqcb5zyBm4",
      authDomain: "nv-city-2f51d.firebaseapp.com",
      projectId: "nv-city-2f51d",
      storageBucket: "nv-city-2f51d.firebasestorage.app",
      messagingSenderId: "313757648006",
      appId: "1:313757648006:web:c8f83006358be09f267d07",
      measurementId: "G-F78EWDN1M6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let user = localStorage.getItem("currentUser") || "InvitÃ©e_" + Math.floor(Math.random()*999);
    localStorage.setItem("currentUser", user);

    // --- NAVIGATION ---
    window.switchTab = (mode) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('secFeed').classList.add('hidden');
        document.getElementById('secGal').classList.add('hidden');
        document.getElementById('secProf').classList.add('hidden');

        document.getElementById('t' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
        document.getElementById('sec' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.remove('hidden');
        
        if(mode === 'prof') {
            document.getElementById('myName').innerText = user;
            document.getElementById('myAvatar').src = `https://ui-avatars.com/api/?name=${user}&background=ff69b4&color=fff`;
        }
    };

    window.updatePseudo = () => {
        const n = document.getElementById('newName').value;
        if(n) { localStorage.setItem("currentUser", n); location.reload(); }
    };

    // --- PUBLICATION (FIREBASE) ---
    document.getElementById('btnPublier').onclick = async () => {
        const text = document.getElementById('pTxt').value;
        const file = document.getElementById('pImg').files[0];
        if(!text && !file) return;

        let base64 = null;
        if(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                await sendToCloud(text, reader.result);
            };
        } else {
            await sendToCloud(text, null);
        }
    };

    async function sendToCloud(t, img) {
        await addDoc(collection(db, "posts"), {
            auteur: user,
            texte: t,
            image: img,
            date: serverTimestamp()
        });
        document.getElementById('pTxt').value = "";
        document.getElementById('pImg').value = "";
        alert("EnvoyÃ© au Cloud ! ðŸŒ¸");
    }

    // --- LECTURE EN TEMPS RÃ‰EL (FIREBASE) ---
    onSnapshot(query(collection(db, "posts"), orderBy("date", "desc"), limit(20)), (snap) => {
        const zone = document.getElementById('feedContent');
        const galZone = document.getElementById('galContent');
        zone.innerHTML = "";
        galZone.innerHTML = "";

        snap.forEach(doc => {
            const p = doc.data();
            const pfp = `https://ui-avatars.com/api/?name=${p.auteur}&background=random`;
            
            // Ajout au fil
            zone.innerHTML += `
                <div class="post">
                    <div class="post-header">
                        <img src="${pfp}" class="mini-avatar">
                        <div><b>${p.auteur}</b></div>
                    </div>
                    <div>${p.texte}</div>
                    ${p.image ? `<img src="${p.image}" class="post-img">` : ''}
                </div>`;
            
            // Ajout Ã  la galerie
            if(p.image) {
                galZone.innerHTML += `<img src="${p.image}" style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px;">`;
            }
        });
    });
</script>
</body>
</html>
